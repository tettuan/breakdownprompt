# ライブラリ概要

渡された引数やオプションから、読み込むプロンプトをテキストテンプレートとして読み込む。内容の解析は不要。
読み込んだテンプレート内の変数（ルール化された文字列）を、受け取ったパラメータ値で置き換える。
出力はテキストとして標準出力へ書き出される。

詳細なユースケースについては、[ユーザーガイド](./user_guide.md)を参照してください。

APIの詳細な仕様については、[APIリファレンス](./api_reference.md)を参照してください。

# 受け取りパラメータ一覧

- template_file : テンプレートとなるプロンプトファイルのパス （必須）
- variables : テンプレート内で置換される変数の key value セット （必須）
  - 詳細は[変数定義](./variables.ja.md)を参照

# プロンプトファイルの取り扱い

テンプレートとなるプロンプトファイルのパスは引数として直接受け取る。ライブラリ内でパスの組み立ては行わない。

## 宣言とパラメータ

初期化時に template_file が指定される。

# プロンプトの読み込みと、パラメータ値の置換

## 出力形式

すべての出力において、プロンプトの内容をテキスト表示します。表示時に「置換処理」を行ったうえで出力します。

ex.： 入力元のテンプレートプロンプトの内容： ```prompt

# example prompt

this is a propmt contents. {input_text_file}

# schema

{schema_file}

# destination path

{destination_path}

````
出力： ```
# example prompt 
this is a propmt contents. ./.agent/breakdown/issues/12345_something.md

# schema
./rules/schema/task/base.schema.yml

# destination path
./.agent/breakdown/tasks/
````

## 置換処理

置換処理は、1つの変数名に1つのクラスを割り当てる。クラスは、置き換える処理のルールを定義している。

流れは、

1. パラメータ検証
   - 必須パラメータの存在確認
   - 変数名の形式チェック
   - パスの妥当性検証

2. テンプレート処理
   - テンプレートファイルの読み込み
   - 変数の抽出と検証

3. 変数置換処理
   - 型に応じた検証の実行
   - 変数の置換
   - エラーハンドリング

### 置換処理の対象変数

変数は2つの側面で定義される：

1. 予約変数：事前定義された変数名と、対応する型、変数を処理するクラス
2. テンプレート変数：テンプレートのスキャンで発見された変数名

詳細は[変数定義](./variables.ja.md)を参照してください。

BreakdownPromptの受け取りパラメータ `variables` が許可している変数は次のとおり。 variables.schema_file
でアクセス可能とする。

- schema_file
- input_text
- input_text_file
- destination_path

- 各変数の値の制約
  - `schema_file`: 有効なファイルパス形式
  - `input_text`: テキスト形式の文章
  - `input_text_file`: 有効なファイルパス形式
  - `destination_path`: 有効なディレクトリパス形式

- 検出方法
  - 単純な文字列マッチングで `{variable_name}` パターンを検出
  - 正規表現は使用しない

- 値の検証ルール
  - パスの存在確認
  - ファイルの読み取り権限確認
  - テキストの形式チェック
  - パスの正規化処理

- 検証エラー
  - エラーの型を返す
    - エラー種類ごとに判定できるENUMを含める
    - エラー固有のエラーメッセージを含める
  - 最初のエラーが起きた段階で、処理を呼び出し元へ返す

#### variablesの変数名（キー）の制約ルール

1. キーの命名規則
   - 英数字とアンダースコアのみ使用可能
   - 先頭は英字のみ
   - 大文字小文字を使って構成されていれば命名ルールは問わない

2. キーの一意性
   - 重複するキーは許可しない
   - 大文字小文字を区別する

3. キーの必須性
   - すべてのキーは任意
   - 必須なキーは存在しない

4. キーの検証タイミング
   - 初期化時に一括検証

5. エラー処理
   - 不正なキー検出時はデバッグログに出力
   - 実行は継続（エラーは発生させない）
   - 不正なキーは無視して処理を継続

- 同じ変数が複数回出現した場合は、全て同じ値で置き換える
- 変数の置換順序はシステムの呼び出し順で良い（順不同）
- 再起的な処理は不要
- 変数のエスケープ記載を検知する必要はない（検出しない）

### 置換処理の循環処理・循環参照の対策

1. 1つのテンプレートは1度だけ読み込まれる（繰り返し読み込みしない）
2. テンプレートを１行ずつ処理する
3. １行に対して、変数の「外かっこ」で検出する
4. 検出された「外かっこ」の中身が、変数のキー名と一致するか確認する
5. 一致しなかった変数は置換されずに戻され、一致した変数は置換処理クラスを通した結果が戻される
6. 同じ場所を再起的に処理しない

# エラーハンドリング

- 置換対象の変数はあらかじめ指定されている
  - 指定以外の変数が見つかった場合は、 debug レベルでlog出力する
  - 例外は発生させずスルーする

# テスト

- コア機能の単体テストから統合機能、最終的なユースケースのカバレッジ拡大へと階層的なテストにする
- BreakdownLoggerをテストコードへ入れてデバッグする

## パス検証ルール

パスの検証ルールについては、[パス検証ルール](./path_validation.md)を参照してください。

## 特殊文字の扱い

特殊文字の扱いについては、[特殊文字の扱い](./priority.ja.md)を参照してください。

## 変数の型定義

変数の型定義については、[変数の型定義](./type_of_variables.ja.md)を参照してください。

## セキュリティ考慮

ローカルファイル操作に対して最小限行う。

- パスインジェクション対策
- 特殊文字の処理
- ファイルアクセス権限の確認
- 機密情報の扱いは不要（ログはコンソールへ出力するのみ）

## パフォーマンス考慮

不要。もともと軽量な処理であるため。

# プロンプト管理システム仕様書

## 1. 概要

プロンプト管理システムは、テンプレートベースのプロンプト生成と変数置換を行うフレームワークです。テンプレートファイルと変数パラメータを受け取り、検証と置換処理を行い、最終的なプロンプトを生成します。

詳細なユースケースについては、[ユーザーガイド](./user_guide.md)を参照してください。
APIの詳細な仕様については、[APIリファレンス](./api_reference.md)を参照してください。

## 2. システム構成

### 2.1 入力パラメータ

- `template_file`: テンプレートとなるプロンプトファイルのパス（必須）
- `variables`: テンプレート内で置換される変数の key-value セット（必須）
  - 詳細は[変数定義](./variables.ja.md)を参照

### 2.2 出力形式

すべての出力において、プロンプトの内容をテキスト表示します。表示時に「置換処理」を行ったうえで出力します。

例：

```markdown
# example prompt

this is a propmt contents. ./.agent/breakdown/issues/12345_something.md

# schema

./rules/schema/task/base.schema.yml

# destination path

./.agent/breakdown/tasks/
```

## 3. テンプレートファイル

### 3.1 定義

テンプレートファイルは、変数を含むテキストファイルです。以下の特徴を持ちます：

- 拡張子: `.md`, `.txt`, `.yml` のいずれか
- 内容: テキスト
- 変数形式: `{variable_name}`
- 検証: テキストファイルとしての存在確認のみ
- 注記: マークダウンエディタでの編集を推奨

### 3.2 ファイル形式

#### 3.2.1 サポートされる拡張子

- `.md`: マークダウンファイル
- `.txt`: プレーンテキストファイル
- `.yml`: YAMLファイル

#### 3.2.2 検証ルール

1. ファイルの存在確認
2. 拡張子の検証（`.md`, `.txt`, `.yml` のみ許可）
3. テキストファイルとして読み込み可能かの確認

#### 3.2.3 エラーハンドリング

- 存在しないファイル: `TemplateFileNotFoundError`
- 不正な拡張子: `InvalidTemplateFileExtensionError`
- 読み込み不可: `TemplateFileReadError`

### 3.3 変数定義

テンプレート内の変数は以下の形式で定義します：

```markdown
{variable_name}
```

#### 3.3.1 変数名の命名規則

- 英数字とアンダースコアのみ使用可能
- 先頭は英字のみ
- 大文字小文字を区別

#### 3.3.2 変数の制約

- 同じ変数が複数回出現した場合は、全て同じ値で置き換える
- 変数の置換順序はシステムの呼び出し順で良い（順不同）
- 再起的な処理は不要
- 変数のエスケープ記載を検知する必要はない（検出しない）

## 4. 置換処理

### 4.1 処理の流れ

1. パラメータ検証
   - 必須パラメータの存在確認
   - 変数名の形式チェック
   - パスの妥当性検証

2. テンプレート処理
   - テンプレートファイルの読み込み
   - 変数の抽出と検証

3. 変数置換処理
   - 型に応じた検証の実行
   - 変数の置換
   - エラーハンドリング

### 4.2 変数の検出と処理

- 単純な文字列マッチングで `{variable_name}` パターンを検出
- 正規表現は使用しない
- 1つのテンプレートは1度だけ読み込まれる
- テンプレートを1行ずつ処理する
- 1行に対して、変数の「外かっこ」で検出する
- 検出された「外かっこ」の中身が、変数のキー名と一致するか確認する
- 一致しなかった変数は置換されずに戻され、一致した変数は置換処理クラスを通した結果が戻される
- 同じ場所を再起的に処理しない

### 4.3 変数の型と検証

詳細は[変数の型定義](./type_of_variables.ja.md)を参照してください。

## 5. エラーハンドリング

### 5.1 変数に関するエラー

- 指定以外の変数が見つかった場合は、debugレベルでlog出力する
- 例外は発生させずスルーする

### 5.2 検証エラー

- エラーの型を返す
  - エラー種類ごとに判定できるENUMを含める
  - エラー固有のエラーメッセージを含める
- 最初のエラーが起きた段階で、処理を呼び出し元へ返す

## 6. セキュリティとパフォーマンス

### 6.1 セキュリティ考慮

- パスインジェクション対策
- 特殊文字の処理
- ファイルアクセス権限の確認
- 機密情報の扱いは不要（ログはコンソールへ出力するのみ）

詳細は[特殊文字の扱い](./priority.ja.md)を参照してください。

### 6.2 パフォーマンス考慮

- 軽量な処理であるため、特別な考慮は不要

## 7. テスト

### 7.1 テスト戦略

- コア機能の単体テストから統合機能、最終的なユースケースのカバレッジ拡大へと階層的なテスト
- BreakdownLoggerをテストコードへ入れてデバッグ

### 7.2 パス検証

詳細は[パス検証ルール](./path_validation.md)を参照してください。
