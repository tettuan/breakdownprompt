# ライブラリ仕様書

## 1. システム概要

渡された引数やオプションから、どのプロンプトを用いるか判別する。
プロンプトを読み込み、プロンプト内の変数（ルール化された文字列）を、受け取ったパラメータ値で置き換える。一部の変数の値は、パラメータ値をもとに動的に生成され組み立てられる。

## 2. システム境界

### 2.1 入力インターフェース

- 初期化パラメータ
  - `base_dir`: プロンプトテンプレートのルートディレクトリ
  - `config`: システム設定オブジェクト（オプション）

- プロンプト生成パラメータ
  - `DemonstrativeType`: プロンプトの種類
  - `LayerType`: レイヤー種別
  - `fromLayerType`: 元レイヤー種別
  - `Destination`: 保存先
  - `MultipleFiles`: 複数ファイルか、単独か
  - `Structured`: 階層か、独立

### 2.2 出力インターフェース

- 生成されたプロンプトファイル
- 処理結果のステータス
- エラー情報（発生時）

## 3. コアコンポーネントと責務

### 3.1 プロンプトマネージャー

- プロンプトファイルの特定と読み込み
- パラメータの検証と管理
- プロンプト生成プロセスの調整

### 3.2 プロンプトジェネレーター

- プロンプトテンプレートの解析
- 変数の置換処理
- 出力形式の制御

### 3.3 変数置換クラス群

- 特定の変数パターンに対する置換ロジックの実装
- 置換値の生成ルールの定義

## 4. 状態管理

### 4.1 内部状態

- プロンプトテンプレートのキャッシュ
- 変数置換クラスのレジストリ
- 出力設定の状態

### 4.2 状態遷移

1. 初期化状態
2. テンプレート読み込み状態
3. 変数置換状態
4. 出力生成状態
5. 完了状態

## 5. 依存関係

### 5.1 外部依存

- ファイルシステム
- 設定ファイル
- スキーマ定義

### 5.2 内部依存

- プロンプトテンプレート
- 変数置換クラス
- 出力フォーマッター

## 6. プロンプトファイルの特定

### 6.1 パス生成ルール

- ディレクトリ: `<base_dir>/<DemonstrativeType>/<LayerType>`
- ファイル名: `f_<from_layer_type>.md`

### 6.2 ファイル検索順序

1. 完全一致
2. デフォルトテンプレート
3. フォールバックテンプレート

## 7. プロンプトの読み込みと変数置換

### 7.1 変数パターン

- `{schema_file}`: スキーマファイルのパス
- `{input_markdown}`: 入力マークダウンの内容
- `{input_markdown_file}`: 入力マークダウンファイルのパス
- `{destination_path}`: 出力先パス

### 7.2 置換処理の流れ

1. プロンプトファイルをスキャンし、変数を検出
2. 各変数に対して適切な置換クラスを割り当て
3. パラメータに基づいて置換値を生成
4. 最終的なプロンプトを生成

## 8. 出力制御

### 8.1 出力形式

1. 単一ファイル出力
   - パス: `<Destination>/<generated_filename>.md`
2. 複数ファイル出力
   - 独立したコンテンツとして保存
3. 階層構造出力
   - ディレクトリ構造による親子関係の表現

### 8.2 出力検証

- ファイルパーミッションの確認
- ディスク容量の確認
- 出力先の存在確認

## 9. エラーハンドリング

### 9.1 検証項目

- パラメータの存在と形式
- ファイルの存在
- 変数の定義
- 置換処理の成功

### 9.2 エラー通知

- エラーメッセージの明確な表示
- エラー発生箇所の特定
- リカバリー手順の提示

## 10. セキュリティ要件

### 10.1 ファイルアクセス

- パストラバーサル対策
- ファイルパーミッションの適切な設定
- 一時ファイルの安全な処理

### 10.2 入力検証

- パラメータのサニタイズ
- ファイルパスの検証
- コンテンツの検証

## 11. パフォーマンス要件

### 11.1 処理速度

- テンプレート読み込み: 100ms以内
- 変数置換: 50ms以内
- ファイル出力: 200ms以内

### 11.2 リソース使用

- メモリ使用量: 最大100MB
- ディスクI/O: 最小限に抑制
- キャッシュ戦略: LRU方式

## 12. テスト要件

### 12.1 単体テスト

- 各コンポーネントの独立したテスト
- エッジケースの網羅
- モックオブジェクトの使用

### 12.2 統合テスト

- コンポーネント間の連携テスト
- エンドツーエンドテスト
- パフォーマンステスト

## 13. 拡張性

### 13.1 変数パターン

- 新しいVariableReplacerクラスの実装
- プロンプトジェネレーターへの登録
- 設定ファイルでの有効化

### 13.2 出力形式

- 新しい出力フォーマッターの実装
- 出力設定への新しいオプションの追加
- 設定ファイルでの設定
