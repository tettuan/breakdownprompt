# システム設計書

## 1. システム概要

プロンプト管理システムは、動的なプロンプト生成と管理を行うためのフレームワークです。プロンプトテンプレートとパラメータを受け取り、適切なプロンプトを生成し、指定された形式で出力します。

## 2. コアコンポーネント

### 2.1 プロンプトマネージャー (PromptManager)

#### 責務

- プロンプトファイルの特定と読み込み
- パラメータの検証と管理
- プロンプト生成プロセスの調整

#### 振る舞い

1. 初期化時に `prompt_file_path` を受け取り、プロンプトファイルを特定
2. プロンプト生成時に以下のパラメータを受け取り、適切なプロンプトを生成
   - `prompt_file_path`: プロンプトファイルのパス
   - `variables`: プロンプト内で置換される変数の key value セット

### 2.2 プロンプトジェネレーター (PromptGenerator)

#### 責務

- プロンプトテンプレートの解析
- 変数の置換処理
- 出力形式の制御

#### 振る舞い

1. プロンプトテンプレート内の変数をスキャン
   - 単純な文字列マッチングで `{variable_name}` パターンを検出
   - 正規表現は使用しない
2. 各変数に対して適切な置換クラスを割り当て
3. パラメータに基づいて置換値を生成
   - 同じ変数が複数回出現した場合は、全て同じ値で置き換える
   - 変数の置換順序はシステムの呼び出し順で良い（順不同）
4. 最終的なプロンプトを生成

### 2.3 変数置換クラス群 (VariableReplacer)

#### 責務

- 特定の変数パターンに対する置換ロジックの実装
- 置換値の生成ルールの定義

#### 実装クラス

1. `SchemaFileReplacer`
   - 対象変数: `{schema_file}`
   - スキーマファイルのパスを生成
   - variables.schema_file でアクセス

2. `InputMarkdownReplacer`
   - 対象変数: `{input_markdown}`
   - 入力マークダウンの内容を生成
   - variables.input_markdown でアクセス

3. `InputMarkdownFileReplacer`
   - 対象変数: `{input_markdown_file}`
   - 入力マークダウンファイルのパスを生成
   - variables.input_markdown_file でアクセス

4. `DestinationPathReplacer`
   - 対象変数: `{destination_path}`
   - 出力先パスを生成
   - variables.destination_path でアクセス

### 2.4 出力コントローラー (OutputController)

#### 責務

- 出力先の検証と制御
- ファイルシステム操作の管理
- 出力形式の制御

#### 振る舞い

1. 出力先パスの検証
   - パスの存在確認
   - 書き込み権限の確認
   - パスの正規化処理

2. 出力の生成
   - 単一ファイル出力
   - 複数ファイル出力
   - 構造化出力

3. エラーハンドリング
   - ファイルシステムエラーの処理
   - 権限エラーの処理
   - パス検証エラーの処理

## 3. 変数管理と検証

### 3.1 変数の命名規則

- 英数字とアンダースコアのみ使用可能
- 先頭は英字のみ
- 大文字小文字の区別あり

### 3.2 変数の制約

- キーの一意性（重複不可）
- すべてのキーは任意（必須キーなし）
- 初期化時の一括検証

### 3.3 変数の検証

- キーの形式チェック
- 値の形式チェック
- ファイルパスの存在確認
- マークダウンの形式チェック

### 3.4 エラーハンドリング

- 未知の変数検出時はデバッグログに出力
- 実行は継続（エラーは発生させない）
- 不正なキーは無視して処理を継続

## 4. セキュリティ対策

### 4.1 ファイル操作セキュリティ

- パスインジェクション対策
  - パスの正規化処理
  - 特殊文字のエスケープ処理
  - 相対パスの制限

- ファイルアクセス制御
  - 最小権限の原則に基づくアクセス
  - ファイル操作の制限
  - 権限チェックの実装

### 4.2 入力値検証

- パスの検証
  - 存在確認
  - 形式チェック
  - 正規化処理

- マークダウンの検証
  - 形式チェック
  - 特殊文字の処理
  - サイズ制限

## 5. パフォーマンス最適化

### 5.1 処理の効率化

- テンプレート解析の最適化
  - 変数検出の効率化
  - キャッシュの活用

- ファイル操作の最適化
  - バッファリング
  - 非同期処理
  - リソース管理

### 5.2 メモリ管理

- 大きなファイルの処理
  - ストリーミング処理
  - メモリ使用量の制御

- リソース解放
  - 適切なタイミングでの解放
  - エラー時のクリーンアップ

## 6. テスト戦略

### 6.1 テスト階層

- コア機能の単体テスト
- 統合機能テスト
- 最終的なユースケーステスト

### 6.2 デバッグ機能

- BreakdownLoggerをテストコードへ入れてデバッグする
- ログレベルによる出力制御
