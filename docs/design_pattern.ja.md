# システム設計書

## 1. システム概要

プロンプト管理システムは、動的なプロンプト生成と管理を行うためのフレームワークです。プロンプトテンプレートとパラメータを受け取り、適切なプロンプトを生成し、指定された形式で出力します。

## 2. コアコンポーネント

### 2.1 プロンプトマネージャー (PromptManager)

#### 責務

- プロンプトファイルの特定と読み込み
- パラメータの検証と管理
- プロンプト生成プロセスの調整

#### 振る舞い

1. 初期化時に `base_dir` を受け取り、プロンプトのルートディレクトリを設定
2. プロンプト生成時に以下のパラメータを受け取り、適切なプロンプトファイルを特定
   - `DemonstrativeType`: プロンプトの種類
   - `LayerType`: レイヤー種別
   - `fromLayerType`: 元レイヤー種別
3. プロンプトファイルのパスを生成
   - ディレクトリ: `<base_dir>/<DemonstrativeType>/<LayerType>`
   - ファイル名: `f_<from_layer_type>.md`

### 2.2 プロンプトジェネレーター (PromptGenerator)

#### 責務

- プロンプトテンプレートの解析
- 変数の置換処理
- 出力形式の制御

#### 振る舞い

1. プロンプトテンプレート内の変数をスキャン
2. 各変数に対して適切な置換クラスを割り当て
3. パラメータに基づいて置換値を生成
4. 最終的なプロンプトを生成

### 2.3 変数置換クラス群 (VariableReplacer)

#### 責務

- 特定の変数パターンに対する置換ロジックの実装
- 置換値の生成ルールの定義

#### 実装クラス

1. `SchemaFileReplacer`
   - 対象変数: `{schema_file}`
   - スキーマファイルのパスを生成

2. `InputMarkdownReplacer`
   - 対象変数: `{input_markdown}`
   - 入力マークダウンの内容を生成

3. `InputMarkdownFileReplacer`
   - 対象変数: `{input_markdown_file}`
   - 入力マークダウンファイルのパスを生成

4. `DestinationPathReplacer`
   - 対象変数: `{destination_path}`
   - 出力先パスを生成

## 3. 出力制御

### 3.1 出力設定

以下のパラメータにより出力形式を制御：

- `Destination`: 出力先ディレクトリ
- `MultipleFiles`: 複数ファイル出力フラグ
- `Structured`: 階層構造フラグ

### 3.2 出力形式

1. 単一ファイル出力
   - プロンプト内容を1つのファイルに出力
   - パス: `<Destination>/<generated_filename>.md`

2. 複数ファイル出力
   - プロンプト内容を複数のファイルに分割して出力
   - 各ファイルは独立したコンテンツとして保存

3. 階層構造出力
   - プロンプト内容を階層構造で出力
   - 親子関係をディレクトリ構造で表現

## 4. エラーハンドリング

### 4.1 必須エラーチェック

1. パラメータ検証
   - 必須パラメータの存在確認
   - パラメータ値の形式検証

2. ファイル存在チェック
   - プロンプトテンプレートファイルの存在確認
   - 出力先ディレクトリの存在確認

3. 変数置換エラー
   - 未定義変数の検出
   - 置換処理の失敗検出

### 4.2 エラー通知

- エラーメッセージの明確な表示
- エラー発生箇所の特定
- リカバリー手順の提示

## 5. 拡張性

### 5.1 新しい変数パターンの追加

1. 新しい `VariableReplacer` クラスの実装
2. プロンプトジェネレーターへの登録
3. 設定ファイルでの有効化

### 5.2 出力形式の拡張

1. 新しい出力フォーマッターの実装
2. 出力設定への新しいオプションの追加
3. 設定ファイルでの設定
