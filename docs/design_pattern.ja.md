# システム設計書

## 1. システム概要

プロンプト管理システムは、テンプレートベースのプロンプト生成と変数置換を行うフレームワークです。テンプレートファイルと変数パラメータを受け取り、検証と置換処理を行い、最終的なプロンプトを生成します。

> 本システムは、プロンプトの再利用性と保守性を高めることを目的としています。テンプレートと変数の分離により、プロンプトの変更が容易になり、また変数の型安全性を確保することで、実行時のエラーを防ぎます。

## 2. コアコンポーネント

> 各コンポーネントは単一責任の原則に基づいて設計されています。特に、検証処理と置換処理を分離することで、各コンポーネントの役割を明確にし、テスト容易性と保守性を高めています。

### 2.1 プロンプトマネージャー (PromptManager)

#### 責務

- パラメータの検証と管理
- テンプレート処理の調整
- 変数置換処理の調整
- エラーハンドリングの一元管理

#### 振る舞い

1. パラメータ検証
   - 必須パラメータの存在確認
   - 変数名の形式チェック（[変数定義](./variables.ja.md)に準拠）
   - パスの妥当性検証

2. テンプレート処理
   - テンプレートファイルの読み込み
   - マークダウン形式の検証
   - 変数の抽出と検証（予約変数とテンプレート変数の照合）

3. 変数置換処理
   - 型に応じた検証の実行（[型定義](./type_of_variables.ja.md)に準拠）
   - 変数の置換
   - エラーハンドリング

### 2.2 プロンプトジェネレーター (PromptGenerator)

#### 責務

- テンプレートの解析と変数抽出
- 変数置換処理の実行
- 置換結果の生成

#### 振る舞い

1. テンプレート解析
   - `{variable_name}` パターンの検出（[変数定義](./variables.ja.md)の命名規則に準拠）
   - 変数の抽出とリスト化
   - 予約変数との照合

2. 変数置換
   - 各変数の型に応じた検証
   - 変数の置換実行
   - 置換結果の生成

### 2.3 バリデーター群

> バリデーター群は、入力値の検証を専門的に行うコンポーネントです。型安全性を確保し、不正な入力によるエラーを早期に検出することで、システムの信頼性を高めます。

#### 2.3.1 変数バリデーター (VariableValidator)

##### 責務

- 変数名の形式チェック（[変数定義](./variables.ja.md)の命名規則に準拠）
- 変数の型検証（[型定義](./type_of_variables.ja.md)に準拠）
- マークダウン形式の検証

##### 振る舞い

1. 変数名検証
   - 英数字とアンダースコアのみ
   - 先頭は英字のみ
   - 大文字小文字の区別
   - 予約変数との照合

2. 型検証
   - パス型変数の検証
   - マークダウン型変数の検証
   - 型定義に基づく検証

#### 2.3.2 パスバリデーター (PathValidator)

##### 責務

- ファイルパスの検証（[パス検証ルール](./path_validation.md)に準拠）
- ディレクトリパスの検証
- パスの正規化

##### 振る舞い

1. パス検証
   - 存在確認（[パス検証ルール](./path_validation.md)に準拠）
   - 形式チェック
   - 正規化処理
   - セキュリティ検証（パストラバーサル防止など）

### 2.4 ファイルユーティリティ (FileUtils)

#### 責務

- ファイルの読み書き
- パスの操作
- ファイルシステムの操作

#### 振る舞い

1. ファイル操作
   - テンプレートファイルの読み込み
   - 出力ファイルの書き込み
   - パスの正規化

## 3. 処理フロー

> 処理フローは、パラメータ検証→テンプレート処理→変数置換の順で実行されます。各ステップでエラーが発生した場合は即座に処理を中断し、エラーメッセージを返却します。これにより、無効な状態での処理継続を防ぎます。

### 3.1 パラメータ検証フロー

1. 必須パラメータチェック
   - `template_file`の存在確認
   - `variables`の存在確認

2. 変数名検証
   - 命名規則のチェック（[変数定義](./variables.ja.md)に準拠）
   - 重複チェック
   - 予約変数との照合

3. パス検証
   - テンプレートファイルのパス検証（[パス検証ルール](./path_validation.md)に準拠）
   - 変数内のパス検証
   - セキュリティ検証

### 3.2 テンプレート処理フロー

1. ファイル読み込み
   - テンプレートファイルの読み込み
   - エンコーディングの確認

2. マークダウン検証
   - 形式チェック
   - 特殊文字の処理

3. 変数抽出
   - 変数パターンの検出（[変数定義](./variables.ja.md)の記法に準拠）
   - 変数リストの生成
   - 予約変数との照合

### 3.3 変数置換フロー

1. 型検証
   - パス型変数の検証（[型定義](./type_of_variables.ja.md)に準拠）
   - マークダウン型変数の検証
   - 予約変数の型チェック

2. 置換処理
   - 変数の置換
   - 結果の生成

## 4. エラーハンドリング

> エラーハンドリングは、エラーの早期検出と適切なエラーメッセージの提供を重視しています。エラー発生時は即座に処理を中断し、ユーザーに具体的な解決方法を提示することで、デバッグの効率を高めます。

### 4.1 エラータイプ

1. バリデーションエラー
   - パラメータ検証エラー
   - 変数名検証エラー
   - パス検証エラー
   - マークダウン検証エラー

2. ファイルシステムエラー
   - ファイル読み書きエラー
   - パス操作エラー

### 4.2 エラー処理方針

1. 即時中断
   - エラー発生時は即座に処理を中断
   - エラーメッセージを返却

2. エラーメッセージ
   - 具体的なエラー内容
   - エラー発生箇所の特定
   - 解決方法の提示

## 5. セキュリティ対策

> セキュリティ対策は、最小権限の原則に基づいて設計されています。特に、パス操作とファイル操作におけるセキュリティリスクを最小限に抑えることで、システムの安全性を確保します。

### 5.1 パス操作

- パスインジェクション対策（[パス検証ルール](./path_validation.md)に準拠）
- 相対パスの制限
- 特殊文字の処理
- ディレクトリトラバーサル防止

### 5.2 ファイル操作

- 最小権限の原則
- アクセス権限の確認（[パス検証ルール](./path_validation.md)に準拠）
- ファイル操作の制限

## 6. テスト戦略

> テスト戦略は、単体テストから統合テスト、ユースケーステストまで、段階的なアプローチを採用しています。特に、バリデーションとエラーハンドリングのテストを重視し、システムの信頼性を確保します。

### 6.1 テスト階層

1. 単体テスト
   - 各コンポーネントの機能テスト
   - バリデーションのテスト

2. 統合テスト
   - コンポーネント間の連携テスト
   - エラーハンドリングのテスト

3. ユースケーステスト
   - 実際の使用シナリオのテスト
   - エッジケースのテスト

### 6.2 デバッグ機能

- テスト専用のロガー
- ログレベルの制御
- エラー情報の詳細化
