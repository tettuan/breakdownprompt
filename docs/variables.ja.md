# 変数

変数は、2つの側面で定義される。

1. 事前定義：事前定義された変数名と、対応する型、変数を処理するクラス
2. テンプレート記法: テンプレートのスキャンで発見された変数名

上記の1は「予約変数」と定義する。
2は「テンプレート変数」と定義する。

## 変数の関係性

### 予約変数とテンプレート変数の違い

| 項目       | 予約変数                                                           | テンプレート変数                                        |
| ---------- | ------------------------------------------------------------------ | ------------------------------------------------------- |
| 定義       | システムで事前に定義された変数名と対応するクラス                   | テンプレート内の `{variable_name}` 記法で抽出される変数 |
| 例         | `schema_file`, `input_text`, `input_text_file`, `destination_path` | テンプレート内の `{schema_file}`, `{input_text}` など   |
| 固定性     | 変数名は固定                                                       | 変数名はテンプレートの記載に依存                        |
| クラス対応 | 対応するクラスが存在する                                           | クラス対応は不要                                        |
| 検証       | 予約変数として検証される                                           | テンプレート内の記法としてのみ検証                      |

### variables とテンプレート変数の関係

| 項目     | 説明                                                       |
| -------- | ---------------------------------------------------------- |
| 入力     | variables パラメータとして渡される                         |
| 制約     | 予約変数のみを受け取る                                     |
| 任意性   | すべての変数は任意（空でも可）                             |
| エラー   | 予約変数以外の変数はエラーとなる                           |
| 処理     | テンプレート変数が予約変数と一致した場合のみ置換処理される |
| 未定義時 | テンプレート変数がそのまま出力される                       |

### variables と予約変数の関係

| 項目           | 説明                                           |
| -------------- | ---------------------------------------------- |
| 入力           | variables パラメータとして渡される             |
| 制約           | 予約変数のみを受け取る                         |
| 任意性         | すべての変数は任意（空でも可）                 |
| エラー         | 予約変数以外の変数はエラーとなる               |
| 処理           | 対応する予約変数のクラスが処理を実行           |
| 値の使用       | variables の値が存在する場合は、その値を使用   |
| デフォルト処理 | 値が存在しない場合は、クラスの定義に従って処理 |

##　予約変数
予約変数は、メインコードで定義される。
型及びクラス名の定義が必要であり、必ず事前に定義されたリストとなる。

このアプリケーションは、予約変数名と値を variables の値として受け取る。
variablesでの存在有無は全て任意。

詳細な型定義については、[型定義ドキュメント](./type_of_variables.ja.md)を参照してください。

### バリデーション

このアプリケーションへ、引数として渡すことができるのは、予約変数のみである。
予約変数以外に、引数で渡された変数は、エラーを出力する。
エラーメッセージは、別途エラー定義に従う。

### BreakdownPromptでの変数バリデーション

BreakdownPrompt（PromptManager）に渡される変数は、必ず予約変数リストに含まれている必要がある。
具体的には：

1. 変数名の検証
   - 渡された変数のキーが予約変数リストに存在するかチェック
   - 存在しない変数名が渡された場合、エラーを出力

2. 変数値の検証
   - 予約変数リストで定義された型に従って値の検証を行う
   - 型が一致しない場合、エラーを出力

3. 処理の流れ
   - 変数が渡された時点で、予約変数リストとの照合を行う
   - 照合に失敗した場合、処理を中断しエラーを返す
   - 照合に成功した場合のみ、後続の処理（テンプレート変数の置換など）を実行

この検証により、未定義の変数が使用されることを防ぎ、型安全性を確保する。

## テンプレート変数

テンプレート変数は、テンプレートをスキャンするときに、`{variable}` 記法に一致したパターンから取得される。

テンプレートには、事前に予期できない名称が使われる可能性があるため、予約変数とは扱い方を分ける。

- 検出:
  - "something {variable_name} here."
  - "something{variable_name}here."
  - "something{variable_name}here."
  - "something {variable_name} here. \n{variable_name}"
- 検出しない:
  - "something { variable_name } here."
  - "something{ variable_name }here."
  - "something{ variable_name}here."
  - "something{variable_name }here."
  - "something {{variable_name}} here is not detected."
  - "something {{variable_name} here is not detected."
  - "something {variable_name}} here is not detected."
  - "something{{variable_name}}here is not detected."
  - "something{{variable_name1}, {variable_name2}}here is not detected."
  - "something {{variable name}} here is not detected."
  - "something {{variable\nname}} here is not detected."

### バリデーション

テンプレート変数に用いることができる文字列は以下のルールである。

- 英数字とアンダースコアのみ使用可能
- 先頭は英字のみ
- 大文字小文字を区別

### テンプレート変数の発見

- テンプレートを１行ずつスキャンし、変数を発見したときにトリガーを発動する。「変数発見トリガー」と定義する。発見の都度、トリガーが発動する。

「変数発見トリガー」を起点に、「テンプレート変数の置換処理」が行われる。

同じ変数名を複数回呼び出すことも可能。（複数回の呼び出しをハンドリングする必要はない）

# テンプレート変数の置換処理

「変数発見トリガー」を起点に、以下の処理が行われる。

- 発見されたテンプレート変数が、「予約変数」の名称に一致するかチェック
  - yes: 後続処理を継続
  - no : 変数処理を中断し、「処理をスキップする」よう返却する
- 「予約変数」に対応するクラスのインスタンスを生成する
  - variables で渡された引数値があれば、用いる
  - variables に渡されていない場合は、値がNullとして扱う
  - Null値をエラーとするか、空白とするかは、各クラスの定義に任せる
- インスタンスの変換処理を実行し、変換結果を取得する
  - 引数値の加工処理や、加工方法は、クラス定義に任せる
  - 変数に共通の返却型を受け取る
- 変換結果を文字列化してテンプレートへ返却する（変数の記述箇所を、返却値で置き換える）

# 予約変数とテンプレート変数の一致

最終的には予約変数と一致したテンプレート変数のみが用いられる。
その理由は、

1. 予約変数は事前定義されている。
2. テンプレート変数がトリガーされたとき、予約変数名と一致した場合のみ置換処理される。
